<!doctype html>




























<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en-us"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>What are symbols and why they are needed? - Programming blog</title>

  
  <meta name="theme-color" />

  
  
  
  <meta name="description" content="In order to fully undestand usage symbols you will need to undestand basics of C&#43;&#43; compilation. This article will explain what are symbols in context of compilation by walking you step by step through compilation phases." />
  <meta name="author" content="Programming blog" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://stepniakadam.github.io/main.min.css" />

  
  <script
    defer
    src="https://stepniakadam.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
   
  <link rel="preload" as="image" href="https://stepniakadam.github.io/theme.png" />

  
  
  
  

  
  

  
  

  
  <link rel="icon" href="https://stepniakadam.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://stepniakadam.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.92.2" />

  
  

  
  
  
  
  
  <meta itemprop="name" content="What are symbols and why they are needed?">
<meta itemprop="description" content="In order to fully undestand usage symbols you will need to undestand basics of C&#43;&#43; compilation. This article will explain what are symbols in context of compilation by walking you step by step through compilation phases."><meta itemprop="datePublished" content="2022-11-16T18:38:01+01:00" />
<meta itemprop="dateModified" content="2022-11-16T18:38:01+01:00" />
<meta itemprop="wordCount" content="1277">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="What are symbols and why they are needed?"/>
<meta name="twitter:description" content="In order to fully undestand usage symbols you will need to undestand basics of C&#43;&#43; compilation. This article will explain what are symbols in context of compilation by walking you step by step through compilation phases."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="https://stepniakadam.github.io/"
      >Programming blog</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">What are symbols and why they are needed?</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Nov 16, 2022</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>In order to fully undestand usage symbols you will need to undestand basics of C++ compilation. This article will explain what are symbols in context of compilation by walking you step by step through compilation phases.</p>
<h3 id="compilation-steps">Compilation steps</h3>
<p>Compilation will be explained on following &lsquo;Hello World&rsquo; example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
   std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Hello world&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Then the following compilation steps are performed:</p>
<h4 id="1-preprocessing">1. Preprocessing</h4>
<p>This is mostly about <strong>copy-pasting text files</strong> where they were included. Also macro expansion is done and some logic can be applied there, but you should avoid playing with preprocessor as it does not know types. Command used for stopping compilation after preprocessing in gcc is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">g++ -E main.cpp -o main.i
</code></pre></div><p>If executed it outputs <strong>32098 lines of iostream + couple of lines of main.cpp</strong> file.</p>
<p>At this point your main.cpp code can be really messed up and you will not see any compiler complaints. No syntax and types checks are performed. You will only know if you mess up syntax around preprocessor macros.</p>
<h4 id="2-translating-into-assembly">2. Translating into assembly</h4>
<p>This step will translate main.i into main.s ASCII assembly file. It is still not undestandable by an operation system, so it cannot be loaded into memory and started. It&rsquo;s just a human-readable <strong>textual representation of assembly code</strong>. Command used for perform this step is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">g++ main.i -S -o main.s
</code></pre></div><p>And it ouputs 85 lines of assembly file. There is bunch of code divided by sections and I will not dive deep into it. At this point you have to know that there will be many such files in larger project, so from your perspective is&rsquo;s just a <strong>file containing some chunks of code in ASCII form</strong>. I&rsquo;m putting bellow couple of lines of the output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">.LFB2201:
        <span style="color:#a6e22e">.cfi_startproc</span>
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">.cfi_def_cfa_offset</span> <span style="color:#ae81ff">16</span>
        <span style="color:#a6e22e">.cfi_offset</span> <span style="color:#ae81ff">6</span>, -<span style="color:#ae81ff">16</span>
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">.cfi_def_cfa_register</span> <span style="color:#ae81ff">6</span>
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$65535</span>, %esi
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$1</span>, %edi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">_Z41__static_initialization_and_destruction_0ii</span>
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">.cfi_def_cfa</span> <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">8</span>
        <span style="color:#a6e22e">ret</span>
        <span style="color:#a6e22e">.cfi_endproc</span>

</code></pre></div><h4 id="3-translating-into-an-object-file">3. Translating into an object file</h4>
<p>This step result with creating and object file in format allowing to combine many of such files into one executable object. The file is divided into sections with code, data, read-only data, symbol table, debbuging symbols and some others mainly required for relocations during linkage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">g++ main.s -c -o main.o
</code></pre></div><p>The most interesting part for us at this point is section with symbol table. It can be seen by executing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nm -u main.o
</code></pre></div><p>The command will show undefined symbols only and it this case contains</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">_atexit
                 U __dso_handle
                 U _ZNSolsEPFRSoS_E
                 U _ZNSt8ios_base4InitC1Ev
                 U _ZNSt8ios_base4InitD1Ev
                 U _ZSt4cout
                 U _ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_
                 U _ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc
</code></pre></div><p>It is basically a list of symbols that the object knows about (were declared) but has no definiton of. During the linkage it will look for them and properly reallocate code and data. Each symbol outputed above is mangled which means it decorates used name with some more information allowing to uniquely indentify function, structure, class, variable ect. As function can be overloaded then parameters it should contains parameter types. Manging is reversable and can be done in this page: <a href="http://demangler.com/">http://demangler.com/</a></p>
<h4 id="4-linking-phase">4. Linking phase</h4>
<p>This step will result with an executable file that can be loaded into memory and executed. At this compilation stage there is a set of object files with plenty of undefined symbols, hopefully defined by other objects. But in our case there is only one object file (main.o), right? So why we still need this phase?</p>
<p>In fact there are more object existing in the system that compiler already know about. They don&rsquo;t have to be given to it explilicty in linkage command. But we can stil know what linker does for us by using additional flag -v (verbose):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">g++ -v main.o -o program
</code></pre></div><p>Among other things it outputs gcc options used by compiler and linker:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cfg" data-lang="cfg"><span style="color:#a6e22e">COLLECT_GCC_OPTIONS</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-v&#39; &#39;-o&#39; &#39;program&#39; &#39;-shared-libgcc&#39; &#39;-mtune=generic&#39; &#39;-march=x86-64&#39; &#39;-dumpdir&#39; &#39;program.&#39;
</span><span style="color:#e6db74"> /opt/rh/devtoolset-11/root/usr/libexec/gcc/x86_64-redhat-linux/11/collect2 -plugin /opt/rh/devtoolset-11/root/usr/libexec/gcc/x86_64-redhat-linux/11/liblto_plugin.so -plugin-opt=/opt/rh/devtoolset-11/root/usr/libexec/gcc/x86_64-redhat-linux/11/lto-wrapper -plugin-opt=-fresolution=/tmp/cc8Fkmdb.res -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lgcc --build-id --no-add-needed --eh-frame-hdr --hash-style=gnu -m elf_x86_64 -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o program /lib/../lib64/crt1.o /lib/../lib64/crti.o /opt/rh/devtoolset-11/root/usr/lib/gcc/x86_64-redhat-linux/11/crtbegin.o -L/opt/rh/devtoolset-11/root/usr/lib/gcc/x86_64-redhat-linux/11 -L/opt/rh/devtoolset-11/root/usr/lib/gcc/x86_64-redhat-linux/11/../../../../lib64 -L/lib/../lib64 -L/usr/lib/../lib64 -L/opt/rh/devtoolset-11/root/usr/lib/gcc/x86_64-redhat-linux/11/../../.. main.o -lstdc++ -lm -lgcc_s -lgcc -lc -lgcc_s -lgcc /opt/rh/devtoolset-11/root/usr/lib/gcc/x86_64-redhat-linux/11/crtend.o /lib/../lib64/crtn.o</span>
</code></pre></div><p>There is list of libraries given as arguments with &lsquo;-l&rsquo; suffix and <code>-lstdc++</code> among them containing standard library functions definitions. In our example main function uses <code>std::cout</code> (mangled to <code>_ZSt4cout</code>) that is not defined in that object file. From that reason &lsquo;nm main.o&rsquo; will returns:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">U _ZSt4cout
</code></pre></div><p>When the program is linked then definition is provided and symbol is no longer unresolved:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ae81ff">0000000000404060</span> B _ZSt4cout@GLIBCXX_3.4
</code></pre></div><h3 id="why-symbols-are-needed-for-linkage">Why symbols are needed for linkage?</h3>
<p>Before linkage there is group of obj files containing &lsquo;references&rsquo; to other objects (Object A may call function defined in Object B, refer to a variable, ect). When code is compiled to assembly</p>
<h4 id="example">Example:</h4>
<p><code>main.cpp:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">foo</span>();

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
   foo();
   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

</code></pre></div><p><code>Foo.cpp:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">void</span>) {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    i<span style="color:#f92672">++</span>;
}
</code></pre></div><p>Each file is compiled into a relocatable object file. Main function (from translation unit main.o) calls function <code>foo()</code> that is defined in other translation unit (Foo.o). When we look at dissassembly of each object the we could see that call to function <code>foo()</code> does not refer to definition in <code>Foo.o</code>. Address of the function definition is unknown at compilation time of <code>Main.o</code>. Starting from address 0x05 there is address of the function <code>foo()</code> 0x00000000.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">0000000000000000 &lt;main&gt;:
   0:   55                      push   %rbp
   1:   48 89 e5                mov    %rsp,%rbp
   4:   e8 00 00 00 00          call   9 &lt;main+0x9&gt;
   9:   b8 00 00 00 00          mov    $0x0,%eax
   e:   5d                      pop    %rbp
   f:   c3                      ret
</code></pre></div><p>At this point compiler produces entry in symbol table describing undefined reference by symbol name, type and offset from beggining of the section:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">RELOCATION</span> <span style="color:#66d9ef">RECORDS</span> <span style="color:#66d9ef">FOR</span> [.<span style="color:#66d9ef">text</span>]:
<span style="color:#a6e22e">OFFSET</span>           <span style="color:#66d9ef">TYPE</span>              <span style="color:#66d9ef">VALUE</span> 
<span style="color:#ae81ff">0000000000000005</span> <span style="color:#66d9ef">R_X86_64_PLT32</span>    <span style="color:#66d9ef">_Z3foov-0x0000000000000004</span>
</code></pre></div><p>As it starts 5 bytes from the beggining of section text then offset equals 0x05. Undefined symbol will be found by linker in next stage in Foo.o containing full defintion of the function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">0000000000000000 &lt;_Z3foov&gt;:
   0:   55                      push   %rbp
   1:   48 89 e5                mov    %rsp,%rbp
   4:   8b 05 00 00 00 00       mov    0x0(%rip),%eax        # a &lt;_Z3foov+0xa&gt;
   a:   83 c0 01                add    $0x1,%eax
   d:   89 05 00 00 00 00       mov    %eax,0x0(%rip)        # 13 &lt;_Z3foov+0x13&gt;
  13:   90                      nop
  14:   5d                      pop    %rbp
  15:   c3                      ret
</code></pre></div><p>While combining sections together linker will update addresses to their final values (both intruction addresses and reference values). These will correspond to memory where program will be actuall placed in memory after loading.
Going back to our example: when binary is linked then call to <code>foo()</code> references to relative address <code>0x07</code> containing defintion of the function. <code>.text</code> sections of 2 different translation units were merged together and their addresses where updated accordingly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">0000000000401166 &lt;main&gt;:                                                                            
  401166:       55                      push   %rbp                                                 
  401167:       48 89 e5                mov    %rsp,%rbp                                            
  40116a:       e8 07 00 00 00          call   401176 &lt;_Z3foov&gt;                                     
  40116f:       b8 00 00 00 00          mov    $0x0,%eax                                            
  401174:       5d                      pop    %rbp                                                 
  401175:       c3                      ret                                                         
                                                                                                    
0000000000401176 &lt;_Z3foov&gt;:                                                                         
  401176:       55                      push   %rbp                         
  401177:       48 89 e5                mov    %rsp,%rbp                                      
  40117a:       48 8d 05 8f 0e 00 00    lea    0xe8f(%rip),%rax 
  401181:       48 89 c6                mov    %rax,%rsi                                            
  401184:       48 8b 05 65 2e 00 00    mov    0x2e65(%rip),%rax                                    
  40118b:       48 89 c7                mov    %rax,%rdi                                            
  40118e:       e8 dd fe ff ff          call   
  401193:       48 8b 15 5e 2e 00 00    mov    0x2e5e(%rip),%rdx 
</code></pre></div><h3 id="shared-libraries">Shared libraries</h3>
<p>If multiple executables are linked against the same static library then copy of the code is present in each of file. It increases space used by executables by the system, but also increases memory memory consuption of loaded programs.</p>
<p>Shared libraries address these disadvantages by performing linkage at runtime of the program. Library is loaded into memory and shared among many executables. When executable references symbol defined in such libary the address is unknown until loader does it&rsquo;s job.</p></section>

  
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://stepniakadam.github.io/posts/mypost/"
      ><span>Compilation - programmer perspective</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2023
    <a class="link" href="https://stepniakadam.github.io/">Programming blog</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
