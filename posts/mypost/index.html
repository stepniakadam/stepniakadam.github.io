<!doctype html>




























<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en-us"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Compilation - programmer perspective - Programming blog</title>

  
  <meta name="theme-color" />

  
  
  
  <meta name="description" content="Maintaining consistent and well organized physical code structure is challanging and underrestimated part of C&#43;&#43; systems development/maintance. Inproper management of interfaces and depenenies will pose maintainablitity and productivity challanges over time. The article aims to summarize simple solutions and attempts to define enforcement rules for best practices.
Case study Let&rsquo;s assume we are are about to develop small library consumed by many components of the system. Library will communicate with database containing workers entries." />
  <meta name="author" content="Programming blog" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://stepniakadam.github.io/main.min.css" />

  
  <script
    defer
    src="https://stepniakadam.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
   
  <link rel="preload" as="image" href="https://stepniakadam.github.io/theme.png" />

  
  
  
  

  
  

  
  

  
  <link rel="icon" href="https://stepniakadam.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://stepniakadam.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.92.2" />

  
  

  
  
  
  
  
  <meta itemprop="name" content="Compilation - programmer perspective">
<meta itemprop="description" content="Maintaining consistent and well organized physical code structure is challanging and underrestimated part of C&#43;&#43; systems development/maintance. Inproper management of interfaces and depenenies will pose maintainablitity and productivity challanges over time. The article aims to summarize simple solutions and attempts to define enforcement rules for best practices.
Case study Let&rsquo;s assume we are are about to develop small library consumed by many components of the system. Library will communicate with database containing workers entries."><meta itemprop="datePublished" content="2022-10-02T18:13:39+02:00" />
<meta itemprop="dateModified" content="2022-10-02T18:13:39+02:00" />
<meta itemprop="wordCount" content="941">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compilation - programmer perspective"/>
<meta name="twitter:description" content="Maintaining consistent and well organized physical code structure is challanging and underrestimated part of C&#43;&#43; systems development/maintance. Inproper management of interfaces and depenenies will pose maintainablitity and productivity challanges over time. The article aims to summarize simple solutions and attempts to define enforcement rules for best practices.
Case study Let&rsquo;s assume we are are about to develop small library consumed by many components of the system. Library will communicate with database containing workers entries."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="https://stepniakadam.github.io/"
      >Programming blog</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">Compilation - programmer perspective</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Oct 2, 2022</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>Maintaining consistent and well organized physical code structure is challanging and underrestimated part of C++ systems development/maintance. Inproper management of interfaces and depenenies will pose maintainablitity and productivity challanges over time. The article aims to summarize simple solutions and attempts to define enforcement rules for best practices.</p>
<h3 id="case-study">Case study</h3>
<p>Let&rsquo;s assume we are are about to develop small library consumed by many components of the system. Library will communicate with database containing workers entries. Implementation assumes caching for performace reasons.</p>
<p><strong>Solution 1 -</strong> Quick reasearch reveals exising implementation of database connector. Implementing proxy with caching mechanism seems to fullfll all requirements.</p>
<p>Possible hpp file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;WorkersDBConnection.hpp&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Workers</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
Workers(WorkersDBConnection<span style="color:#f92672">*</span> connection);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name);

<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> names;
  WorkersDBConnection<span style="color:#f92672">*</span> connection;
};
</code></pre></div><p>All non-functional requirements would be fulliled by such code but it could be written in a better way.</p>
<p><strong>Challanges:</strong></p>
<ul>
<li>Library users will indirectly include other headers. Every change in any of depended headers will tigger build and testing pipeline.</li>
<li>Library is consumed by many translation units. Each indirectly included header will take part in compilation process slowing it down.</li>
<li>Each translation unit will have more declared, but not defined symbols. This will have impact on linkage time.</li>
<li>There is limited control over what&rsquo;s included by depended header file (it may be owned by other team)</li>
<li>&lsquo;Workers&rsquo; class exposes private implementation details in header file. If implementation changes then all depended translation units have to be recompiled and tested.</li>
<li>Unnecessary header dependencies results code growing in each library client</li>
</ul>
<h3 id="first-improvement">First improvement:</h3>
<p>Dependency to <code>WorkersDBConnection</code> can be removed by technique called: forward-declation. At compilation time only size of declared object is required. As long as there are no direct method calls in header file there is no need for translation units to know any other symbol from that class. As result the pointer to declared type is sufficient. :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkersDBConnection</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Workers</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
Workers(WorkersDBConnection<span style="color:#f92672">*</span> connection);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name);

<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> names;
  WorkersDBConnection<span style="color:#f92672">*</span> connection;
};
</code></pre></div><p>GCC has flag <code>-E</code> allowing stoping compilation after preprocessing phase. Together with <code>wc</code> tool can roughtly measure impact on number of lines produced by compiler at first phase of compilation.</p>
<p>Executing command <strong>before change</strong>:</p>
<pre tabindex="0"><code>gcc -E workers.cpp | wc
</code></pre><p>&hellip; produces output:</p>
<pre tabindex="0"><code>  36217   78064  892068
</code></pre><p>while executing command <em><strong>after change</strong></em> produces output:</p>
<pre tabindex="0"><code>26681   57656  658516
</code></pre><p>This <strong>one-line change</strong> excluded from translation unit roughtly <strong>1/3 lines of code</strong> to process. This may seem as not important, but remember we are developing a library consumed by houndreds/thoudands number of translation units in the system. This may be left in other library in the system that would be also popular and transitively adds <strong>10000 lines</strong> of code **to each translation unit.</p>
<p>What imact it has on comilation time?</p>
<p>Before:</p>
<pre tabindex="0"><code>real    0m0.482s
user    0m0.427s
sys     0m0.055s
</code></pre><p>After:</p>
<pre tabindex="0"><code>real    0m0.376s
user    0m0.318s
sys     0m0.058s
</code></pre><p>There is <strong>100 [ms] speed up</strong> on compilation on <strong>each translation unit!</strong>. This is huge considering thousands of such unit compiled in the whole system! Imagine having 1000x0.1 [s] = 100 [s] speadup on each recompilation by forward declaring dependent type.</p>
<h3 id="second-improvement">Second improvement:</h3>
<p>A header file can be considered as inteface of translation unit - it provides declarations and introduces symbols. Unfortunately declaration of a class in C++ cannot be split into chunks containing public and private members. There is no need for a library class user to know implementation details of prive section of the class. There should be no need for all library clients to need to recompile each translation unit that depends on such header. There is no need for all translation units to compile longer due to header included due to implementation details.</p>
<p>In order to mimic C++ inability to understand partialled class declartion we can modify the code in two ways:</p>
<ul>
<li>Extract pure virtual interface from public methods</li>
<li>Use PImpl idiom (pointer to implementation)</li>
</ul>
<p>Both method solevs all described problems but there is no such thing as free lunch. Extracting pure virtual interface means that vtable will be created for Workers object. Creating anoter indirection is sometimes not an option due performance reasons. Such class cannot be constucted without a factory method returing pointer. This way concrete, inheriting class instance is constructed on heap rather than on stack. And again this approach means performance penaly. Additional indirection means more complicated code as well.</p>
<p>Workers.hpp for virtual interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#pragma once
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Workers</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
<span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Workers(){}

<span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
};
</code></pre></div><p>Alternative for this approach is &lsquo;pointer to implementation&rsquo; idiom. It requires creating implementation class called by interface class. This means performance penaly due to indirect calls to implementation and allocation on heap.</p>
<p>Worker.hpp for PImpl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#pragma once
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkersImpl</span>;
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkersDBConnection</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Workers</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
Workers(WorkersDBConnection<span style="color:#f92672">*</span> connection);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> name);

<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
  WorkersImpl<span style="color:#f92672">*</span> pImpl;
  WorkersDBConnection<span style="color:#f92672">*</span> connection;
};
</code></pre></div><p>What impact such change has on compilation time? Let&rsquo;s put pImpl solution as example (there should be no significant difference between theese two as resulting header is almost the same)</p>
<pre tabindex="0"><code>real    0m0.324s
user    0m0.273s
sys     0m0.051s
</code></pre><p>This is not significant, but there was only std::vector dependency removed. Second step (one way or another) in real-life scenario can give incredible improvements in terms of compilation time!.</p>
<h3 id="final-thoughts">Final thoughts:</h3>
<p>A header file is tranlation unit interface and should not be cluttered with unnecessary dependencies. This is extremely important when designing header file that is a library public interface. The article described techniques aiming to resolve related problems, but it&rsquo;s not recommented to apply then everwhere in the code. Gains should allways overweight the cost.</p>
</section>

  
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://stepniakadam.github.io/posts/mypost3/"
      ><span class="mr-1.5">←</span><span>What are symbols and why they are needed?</span></a
    >
    
    
  </nav>
  
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2023
    <a class="link" href="https://stepniakadam.github.io/">Programming blog</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
